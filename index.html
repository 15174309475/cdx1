<!DOCTYPE html>
<html>
<head>
    <title>宇宙成因核素产率计算器</title>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            max-width: 600px;
        }
        .input-group { 
            margin: 15px 0; 
        }
        label {
            display: inline-block;
            width: 100px;
        }
        input { 
            width: 150px;
            padding: 6px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .result { 
            margin-top: 20px; 
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        button { 
            padding: 10px 25px;
            background-color: #2196F3;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 15px;
            font-size: 16px;
        }
        button:hover {
            background-color: #0b7dda;
        }
        .error { 
            color: red; 
            margin: 15px 0;
            padding: 10px;
            background-color: #ffeeee;
            border-radius: 4px;
        }
        .debug-info {
            margin-top: 20px;
            padding: 10px;
            background-color: #f0f0f0;
            border-radius: 4px;
            font-size: 14px;
        }
        h2 {
            color: #333;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
    </style>
</head>
<body>
    <h2>宇宙成因核素产率计算器</h2>
    
    <div class="input-group">
        <label for="latitude">纬度（度）:</label>
        <input type="number" id="latitude" min="-90" max="90" step="0.0001">
    </div>
    <div class="input-group">
        <label for="elevation">海拔（米）:</label>
        <input type="number" id="elevation" min="0" step="1">
    </div>
    <div class="input-group">
        <label for="depth">深度（厘米）:</label>
        <input type="number" id="depth" min="0" step="0.1">
    </div>
    
    <button onclick="calculate()">计算产率</button>
    <div id="error" class="error" style="display: none;"></div>
    <div id="results" class="result" style="display: none;"></div>

    <script>
        // 标称产率（SLHL）
        const P0 = {
            '¹⁰Be': 6,    // atoms/g/yr
            '²⁶Al': 36.8,
            '¹⁴C': 20,
            '³He': 124,
            '²¹Ne': 21,
            '³⁶Cl': 54
        };

        // 输入验证
        function getInputValue(id) {
            const input = document.getElementById(id);
            const value = parseFloat(input.value);
            if (isNaN(value)) {
                input.style.border = "2px solid red";
                return null;
            }
            input.style.border = "1px solid #ccc";
            return value;
        }

        // 精确气压计算
        function calculateAirPressure(elevation) {
            const pressure_hPa = 1013 * Math.pow(1 - elevation / 44330, 5.255);
            return pressure_hPa * (1033 / 1013); // 转换为 g/cm²
        }

        // 海拔校正因子
        function elevationCorrection(elevation, lat) {
            const h = calculateAirPressure(elevation);
            const z = 1033 - h;

            if (z <= 0) return 1.0;
            
            const params = {
                n: 1.0177e-2,
                k: 0.9615,
                alpha: 10.275,
                a: [
                    8.5236e-6, -6.3670e-7, -7.0814e-9,
                    -9.9182e-9, 9.9250e-10, 2.4925e-11,
                    3.8615e-12, -4.8194e-13, -1.5371e-14
                ]
            };
            
            const latRad = Math.abs(lat) * Math.PI / 180;
            const R_C = 14.9 * Math.pow(Math.cos(latRad), 4);
            
            // Term 1
            const expArg = -params.alpha * Math.pow(R_C, -params.k);
            const denominator = 1 + Math.exp(expArg);
            const term1 = (params.n / denominator) * z;

            // Term 2
            const term2 = (
                (params.a[0] + params.a[1] * R_C + params.a[2] * Math.pow(R_C, 2)) * 
                (Math.pow(1033, 2) - Math.pow(h, 2))) / 2;

            // Term 3
            const term3 = (
                (params.a[3] + params.a[4] * R_C + params.a[5] * Math.pow(R_C, 2)) * 
                (Math.pow(1033, 3) - Math.pow(h, 3))) / 3;

            // Term 4
            const term4 = (
                (params.a[6] + params.a[7] * R_C + params.a[8] * Math.pow(R_C, 2)) * 
                (Math.pow(1033, 4) - Math.pow(h, 4))) / 4;

            const c = term1 + term2 + term3 + term4;
            if (c <= 0 || c > 1e6) return 1.0;

            return Math.exp(z/150);
        }

        // 纬度校正因子
        function latitudeCorrection(lat) {
            const alpha = 10.275;
            const k = 0.9615;
            const latRad = Math.abs(lat) * Math.PI / 180;
            const R_C = 14.9 * Math.pow(Math.cos(latRad), 4);
            return R_C <= 0 ? 1.0 : 1 - Math.exp(-alpha * Math.pow(R_C, -k));
        }

        // 深度衰减
        function depthAttenuation(depth) {
            const L = 150;   // 衰减长度 (g/cm²)
            const density = 2.7;  // 密度 (g/cm³)
            return Math.exp(-(depth * density) / L);
        }

        // 主计算函数
        function calculate() {
            // 重置状态
            document.getElementById('error').style.display = 'none';
            document.getElementById('results').style.display = 'none';
            document.querySelectorAll('input').forEach(i => i.style.border = "1px solid #ccc");

            // 获取输入
            const lat = getInputValue('latitude');
            const elev = getInputValue('elevation');
            const depth = getInputValue('depth');

            // 输入验证
            const errorEl = document.getElementById('error');
            if (lat === null || elev === null || depth === null) {
                errorEl.innerHTML = "错误：请填写所有输入项（必须为数字）";
                errorEl.style.display = 'block';
                return;
            }
            
            if (Math.abs(lat) > 90) {
                errorEl.innerHTML = "错误：纬度必须在-90到90度之间";
                errorEl.style.display = 'block';
                return;
            }

            if (elev < 0) {
                errorEl.innerHTML = "错误：海拔不能为负数";
                errorEl.style.display = 'block';
                return;
            }

            if (depth < 0) {
                errorEl.innerHTML = "错误：深度不能为负数";
                errorEl.style.display = 'block';
                return;
            }

            // 计算校正因子
            const elevCorr = elevationCorrection(elev, lat);
            const latCorr = latitudeCorrection(lat);
            const depthCorr = depthAttenuation(depth);

            // 生成结果
            let results = "<h3>校正后产率（atoms/g/yr）:</h3>";
            for (const [nuclide, base] of Object.entries(P0)) {
                const rate = base * elevCorr * latCorr * depthCorr;
                results += `<div>${nuclide}: <b>${rate.toFixed(2)}</b></div>`;
            }

            // 显示调试信息
            results += `
                <div class="debug-info">
                    <h4>调试信息：</h4>
                    <div>海拔校正因子 = ${elevCorr.toFixed(4)}</div>
                    <div>纬度校正因子 = ${latCorr.toFixed(4)}</div>
                    <div>深度衰减因子 = ${depthCorr.toFixed(4)}</div>
                </div>
            `;

            const resultsEl = document.getElementById('results');
            resultsEl.innerHTML = results;
            resultsEl.style.display = 'block';
        }
    </script>
</body>
</html>
