<script>
    // ...（保留其他不变的部分，仅修改以下函数）

    // 修复后的海拔校正函数（完整逻辑）
    function elevationCorrection(elevation, lat) {
        const h = calculateAirPressure(elevation);
        const z = 1033 - h; // 使用正确海平面大气质量 1033 g/cm²

        if (z <= 0) return 1.0;

        const params = {
            n: 1.0177e-2,
            k: -3.9527e-1,
            alpha: 10.275,
            a: [
                8.5236e-6,   -6.3670e-7,  -7.0814e-9,
                -9.9182e-9,  9.9250e-10,  2.4925e-11,
                3.8615e-12, -4.8194e-13, -1.5371e-14
            ]
        };

        const latRad = Math.abs(lat) * Math.PI / 180;
        const R_C = 14.9 * Math.pow(Math.cos(latRad), 4);
        if (R_C <= 1e-6) return 1.0;

        try {
            const x = z;
            // Term 1
            const expArg = -params.alpha * Math.pow(R_C, -params.k);
            const denominator = 1 + Math.exp(expArg);
            const term1 = (params.n / denominator) * x;

            // Term 2
            const term2 = (
                params.a[0] + 
                params.a[1] * R_C + 
                params.a[2] * R_C**2
            ) * x**2 / 2;

            // Term 3
            const term3 = (
                params.a[3] + 
                params.a[4] * R_C + 
                params.a[5] * R_C**2
            ) * x**3 / 3;

            // Term 4
            const term4 = (
                params.a[6] + 
                params.a[7] * R_C + 
                params.a[8] * R_C**2
            ) * x**4 / 4;

            const c = term1 + term2 + term3 + term4;
            if (c <= 0 || c > 1e6) return 1.0;

            return Math.exp(-z / c); // 注意：指数应为负号
        } catch (e) {
            console.error('海拔校正计算错误:', e);
            return 1.0;
        }
    }

    // 纬度校正因子（保持唯一函数定义）
    function latitudeCorrection(lat) {
        const latRad = Math.abs(lat) * Math.PI / 180;
        const R_C = 14.9 * Math.pow(Math.cos(latRad), 4);
        return R_C <= 1e-6 ? 1.0 : 1 - Math.exp(-10.275 * Math.pow(R_C, -0.9615));
    }
</script>
